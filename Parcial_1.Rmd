---
title: "Parcial1"
output:
  html_document: default
  pdf_document: default
  word_document: default
date: '2022-05-02'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```{r}
install.packages("ggplot2")
install.packages("Hmisc")
install.packages("dplyr")
install.packages("sp")
install.packages("psych") 
install.packages("spatialreg")
install.packages("spdep")


library(readxl)
library(spatialreg) ## Librería que permite utilizar datos espaciales
library(spdep)
library(ape)
library(sp)
library(psych) 
library(ggplot2)
library(dplyr)


```

## Carga de datos

```{r}

XPABLO <- read_excel("XPABLO (2).xlsx")
df <- XPABLO[-c(16,17,18,19)]#Eliminar columnas
df$"K/Mg" <- df$K/df$Mg #Cols Variable de interes
colnames(df)
```

## Revision variable MO/Fe

**Trabajar con las demás variables**
  
```{r}

model_1 <- lm(K/Mg ~ Ca, data = df) 
summary(model_1)
```

$$Y_{MO} = 0.214 -0.007X_{Ca}$$
  
```{r}

ggplot(df, aes(y = K/Mg, x = Ca)) +
  geom_point()+
  geom_smooth(method='lm', se = F)
```

## Filtrado Ca > 15 y filtrado K/Mg 

```{r}

df_2 <- df |>
  filter(Ca <= 15)

df_2 <- df |>
  filter(K/Mg <= 1)#tiene valores  outliers por encima 1
df_2
```

```{r}

model_2 <- lm(K/Mg ~ Ca, data = df_2) 
summary(model_2)
```

```{r}

ggplot(df_2, aes(y = K/Mg, x = Ca)) +
  geom_point()+
  geom_smooth(method='lm', se = F)
```

##Plot Histograma Residuales 

```{r}
res_2 <- model_2$residuals
hist(res_2)# Distribucion de poisson?
```

## Con valor absoluto (Coonsiderando negativos)
```{r}

res_2 <- model_2$residuals

```{r}
ggplot(df_2, aes(Long, Lat))+
  geom_point(size = abs(res_2))
```

```{r}
groups_col <- cut(res_2, breaks = 5)

#color <-

ggplot(df_2, aes(Long, Lat, color = groups_col))+
  geom_point(size = 2)
```

## Moran Index para residuales 

```{r}
matriz_dist <- as.matrix(dist(cbind(x = df_2$Long, y = df_2$Lat)))

dim(matriz_dist)
```

```{r}
m_dist_inv <- 1/matriz_dist
m_dist_inv[is.infinite(m_dist_inv)] <- 0
diag(m_dist_inv) <- 0
m_dist_inv
```

```{r}

Moran.I(res_2, m_dist_inv)# Sin Dependicia 
```

## Modelo de regresión multiple

```{r}
model_3 <- lm(K/Mg ~ Ca + CICE, data = df)
summary(model_3)
```

$$Y_{K/Mg} = 0.222 -0.004X_{Ca} -0.003z$$
  
```{r}
res_3 <- model_3$residuals
```

## Indice de Moran para residuales.
```{r}
matriz_dist <- as.matrix(dist(cbind(x = df_2$Long, y = df_2$Lat)))

dim(matriz_dist)
```

```{r}
m_dist_inv <- 1/matriz_dist
m_dist_inv[is.infinite(m_dist_inv)] <- 0
diag(m_dist_inv) <- 0
m_dist_inv
```

```{r}
Moran.I(res_3, m_dist_inv) 
```


```{r}
model_4 <- lm(K/Mg ~ Ca + Long + Lat + I(Long**2) + I(Lat**2), data = df_2) #datos georrefenciados
summary(model_4)
```

```{r}
res_4 <- model_4$residuals
shapiro.test(res_4)
plot(res_4, pch = 16)
Moran.I(res_4, m_dist_inv)#Tiene dependencia espacial(Re turbio)
```

```{r}
groups_col <- cut(res_4, breaks = 5)
ggplot(df_2, aes(Long, Lat, color = groups_col))+
  geom_point(size = 2)
```

## Georeferenciados

```{r}
model_5 <- lm(MO ~ Ca + I(Long**2) + I(Lat**2) + I(Ca**2)+ Long + Lat , data = df_2) #datos georrefenciados
summary(model_5)
```
```{r}
res_5 <- model_5$residuals
Moran.I(res_5, m_dist_inv) #Tiene dependencia espacial(Re turbio)
```

## Modelos de regresión espacial

```{r}
xy = as.matrix(df_2[,c(2,3)])
```

```{r}
contnb <- dnearneigh(coordinates(xy),0,380000,longlat = F)
dlist <- nbdists(contnb, xy)
dlist <- lapply(dlist, function(x) 1/x)            #inverse distance
Wve <- nb2listw(contnb,glist=dlist,style = "W")       #W matriz-standarized
```

## Modelo autoregresivo puro

```{r}
model_auto <- spautolm(K/Mg ~ 1,data = df_2,listw=Wve))**Revisar)**
summary(model_auto)
```

$$Y_{K/Mg} = \alpha_0 + \lambda W Y_{K/Mg} + u\\
u = \rho W u + \epsilon$$
  
  **Si $\rho$ = 0, u = $\epsilon$**
  
  $$Y_{K/Mg} = \alpha_0 + \lambda W Y_{K/Mg} + \epsilon$$
  
```{r}
res_6 <- model_auto$fit$residuals
```

```{r}
Moran.I(res_6, m_dist_inv)#Tiene dependencia espacial(Re turbio)
```




